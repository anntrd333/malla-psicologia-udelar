<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malla Psicología · Interactiva</title>
  <style>
    :root{
      --bg: #fff7fb;
      --pink: #ffd6e8; /* pastel rosa (desbloqueada) */
      --pink-strong: #ffb3d1;
      --locked: #cfcfcf; /* gris claro-medio oscuro */
      --approved: #9e9e9e; /* gris aprobado */
      --text: #2b2b2b;
      --muted: #6b6b6b;
      --card-radius: 8px;
      --gap: 6px;
      --font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:var(--font-family);color:var(--text)}
    .wrap{padding:10px;box-sizing:border-box}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    h1{font-size:18px;margin:0}
    p.lead{margin:0;font-size:13px;color:var(--muted)}

    /* grid: first col modules, then 8 semestre cols, then total col */
    .grid{
      display:grid;
      grid-template-columns:200px repeat(8, minmax(130px,1fr)) 220px;
      gap:8px;
      align-items:start;
      width:100%;
    }

    /* cycle header that spans two semester columns */
    .cycle-header{
      grid-column: span 2;
      background:transparent;
      text-align:center;
      padding:6px 4px;
      font-weight:700;
      border-radius:6px;
      color:var(--muted);
      font-size:13px;
    }

    .col-head{background:transparent;text-align:center;padding:6px 4px;font-weight:700;color:var(--muted);font-size:13px}

    .module-name{background:transparent;padding:6px 8px;font-weight:700;color:var(--muted);font-size:13px}

    .semester-cell{
      min-height:48px;
      background:transparent;
      padding:6px;
      border-radius:6px;
      display:flex;flex-direction:column;gap:6px;
    }

    .course{
      padding:6px 8px;
      border-radius:6px;
      background:var(--pink);
      box-shadow:0 1px 0 rgba(0,0,0,0.03);
      font-size:12px;
      cursor:pointer;
      border:1px solid rgba(0,0,0,0.04);
      display:flex;justify-content:space-between;align-items:center;
      gap:8px;
    }
    .course.locked{background:var(--locked);cursor:default;color:#444}
    .course.approved{background:var(--approved);text-decoration:line-through;color:#fff}
    .course .name{flex:1;text-align:left}
    .course .cred{font-size:11px;color:var(--muted);margin-left:6px}

    .totals-col{padding:6px}
    .total-box{background:white;border-radius:8px;padding:8px;font-size:12px}
    .total-row{display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px dashed #eee}
    .total-row:last-child{border-bottom:none}

    /* make everything compact to try to fit on screen */
    body,html{font-size:13px}

    /* small tooltip/details panel */
    .details{
      position:fixed;right:12px;bottom:12px;background:white;padding:10px;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,0.12);width:260px;font-size:13px;z-index:40;
    }
    .details h4{margin:0 0 6px 0;font-size:13px}
    .details small{color:var(--muted)}

    /* make page non-scrollable but allow internal scroll if needed */
    html,body,.wrap{height:100%}
    .container{height:calc(100% - 70px);overflow:auto;padding-right:6px}

    /* responsive: shrink columns on small screens */
    @media (max-width:1100px){
      .grid{grid-template-columns:160px repeat(8, minmax(100px,1fr)) 180px}
    }
    @media (max-width:900px){
      .grid{grid-template-columns:120px repeat(8, minmax(80px,1fr)) 160px}
      .details{display:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Malla Curricular · Psicología (Plan 2013)</h1>
        <p class="lead">Tonos rosa pastel. Clic para aprobar / deshacer. Mat. bloqueadas por créditos/previaturas.</p>
      </div>
      <div style="text-align:right;font-size:13px;color:var(--muted)">
        Créditos totales: <strong>320</strong>
      </div>
    </header>

    <div class="container">
      <div class="grid" id="grid">
        <!-- column headers will be rendered by JS -->
      </div>
    </div>

    <div style="margin-top:8px;font-size:12px;color:var(--muted)">Nota: las reglas de desbloqueo están basadas en los requisitos que me mandaste. Si hay algún detalle ("examen" vs "curso"), lo trato como equivalente para que la lógica funcione en la malla; si querés lo ajustamos. El estado se guarda localmente en este navegador.</div>
  </div>

  <div class="details" id="details" style="display:none">
    <h4 id="dname">Nombre materia</h4>
    <div id="ddesc"></div>
    <div style="margin-top:8px;font-size:12px;color:var(--muted)" id="dpr">Previaturas: -</div>
    <div style="margin-top:8px;display:flex;gap:6px;justify-content:space-between">
      <button id="dToggle" style="padding:6px;border-radius:8px;border:1px solid #eee;background:var(--pink)">Aprobar / Deshacer</button>
      <button id="dClose" style="padding:6px;border-radius:8px;border:1px solid #eee;background:white">Cerrar</button>
    </div>
  </div>

  <script>
    // ---------- DATA: cursos (tomados tal cual del texto que me pasaste) ----------
    const courses = [
      /* Semestre 1 */
      {id:'historia', name:'Historia de la Psicología', credits:10, module:'Psicología', sem:1, prereqs:[]},
      {id:'neurobiologia', name:'Neurobiología de la Mente', credits:5, module:'Psicología', sem:1, prereqs:[]},
      {id:'fundamentos', name:'Fundamentos de la Psicología', credits:5, module:'Psicología', sem:1, prereqs:[]},
      {id:'epistemologia', name:'Epistemología', credits:5, module:'Metodológico', sem:1, prereqs:[]},
      {id:'herramientasTI', name:'Herramientas para el Trabajo Intelectual', credits:5, module:'Metodológico', sem:1, prereqs:[]},
      {id:'articulacion1', name:'Articulación de Saberes I: Construcción del sujeto y del objeto en Psicología', credits:5, module:'Articulación', sem:1, prereqs:[]},
      {id:'inicioForm', name:'Inicio a la Formación en Psicología', credits:5, module:'Referencial', sem:1, prereqs:[]},

      /* Semestre 2 */
      {id:'desarrollo', name:'Psicología del Desarrollo', credits:10, module:'Psicología', sem:2, prereqs:[]},
      {id:'procesos', name:'Procesos Cognitivos', credits:5, module:'Psicología', sem:2, prereqs:[]},
      {id:'teorias', name:'Teorías Psicológicas', credits:5, module:'Psicología', sem:2, prereqs:[]},
      {id:'metodosExt', name:'Métodos y herramientas orientadas a la extensión', credits:2, module:'Metodológico', sem:2, prereqs:[]},
      {id:'metodologia', name:'Metodología General de la Investigación', credits:5, module:'Metodológico', sem:2, prereqs:[]},
      {id:'entrevista', name:'Entrevista Psicológica', credits:5, module:'Prácticas', sem:2, prereqs:[]},
      {id:'articulacion2', name:'Articulación de Saberes II: Psicología, Género y Derechos Humanos', credits:5, module:'Articulación', sem:2, prereqs:[]},
      {id:'formacionIntegral', name:'Formación Integral', credits:5, module:'Referencial', sem:2, prereqs:[]},

      /* Semestre 3 */
      {id:'psicosocial', name:'Psicología Social', credits:10, module:'Psicología', sem:3, prereqs:[]},
      {id:'sujetoAprendizaje', name:'Psicología, Sujeto y Aprendizaje', credits:5, module:'Psicología', sem:3, prereqs:[]},
      {id:'etica', name:'Ética y Deontología', credits:3, module:'Metodológico', sem:3, prereqs:[]},
      {id:'metodosCual', name:'Métodos y Técnicas cualitativa', credits:5, module:'Metodológico', sem:3, prereqs:[]},
      {id:'articulacion3', name:'Articulación de Saberes III: Clínica y Subjetividad', credits:5, module:'Articulación', sem:3, prereqs:[]},

      /* Semestre 4 */
      {id:'clinica1', name:'Clínica I: Fundamentos psicoanalíticos', credits:5, module:'Psicología', sem:4, prereqs:['articulacion3','teorias','fundamentos','etica','epistemologia']},
      {id:'psicologysalud', name:'Psicología y Salud', credits:10, module:'Psicología', sem:4, prereqs:['desarrollo','fundamentos','articulacion2']},
      {id:'herrClin', name:'Herramientas de la Psicología Clínica', credits:5, module:'Metodológico', sem:4, prereqs:['entrevista','inicioForm','articulacion3','teorias','fundamentos']},
      {id:'metodosCuant', name:'Métodos y Técnicas cuantitativa', credits:5, module:'Metodológico', sem:4, prereqs:['herramientasTI','metodologia','epistemologia']},
      {id:'herrSocial', name:'Herramientas de la Psicología Social', credits:5, module:'Metodológico', sem:4, prereqs:['psicosocial','teorias','fundamentos','articulacion1']},
      {id:'diseno', name:'Diseño de Proyectos', credits:5, module:'Prácticas', sem:4, prereqs:['metodologia','epistemologia','metodosCuant','herramientasTI']},
      {id:'articulacion4', name:'Articulación de Saberes IV: Estado, sociedad y políticas públicas', credits:5, module:'Articulación', sem:4, prereqs:['psicosocial','articulacion1','teorias','fundamentos','articulacion2']},

      /* Semestre 5 */
      {id:'psicopInf', name:'Psicopatología de niños y adolescentes', credits:5, module:'Psicología', sem:5, prereqs:['entrevista','inicioForm','clinica1','articulacion3','teorias','fundamentos']},
      {id:'psicopAdult', name:'Psicopatología de adultos', credits:5, module:'Psicología', sem:5, prereqs:['entrevista','inicioForm','clinica1','articulacion3','teorias','fundamentos']},
      {id:'neuropsico', name:'Neuropsicología', credits:5, module:'Psicología', sem:5, prereqs:['procesos','neurobiologia']},
      {id:'clinica2', name:'Clínica II: Teorías y Técnicas de las Intervenciones', credits:5, module:'Metodológico', sem:5, prereqs:['herrClin','entrevista','inicioForm','clinica1','articulacion3','teorias','fundamentos']},
      {id:'proyectos5', name:'Proyectos (5/10 cred)', credits:10, module:'Prácticas', sem:5, prereqs:['cicloInicialComplete','diseno','metodosCuant','metodosCual']},
      {id:'practicaIntegral', name:'Práctica de Ciclo Formación Integral', credits:10, module:'Prácticas', sem:5, prereqs:['cicloInicialComplete','etica','psicologysalud','sujetoAprendizaje','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'articulacion5', name:'Articulación de Saberes V: La psicología social y el problema de lo creativo', credits:5, module:'Articulación', sem:5, prereqs:['herrSocial','psicosocial','teorias','fundamentos','articulacion1','articulacion4','articulacion2']},
      {id:'construccionIt', name:'Construcción de itinerario', credits:5, module:'Referencial', sem:5, prereqs:['psicosocial','articulacion1','teorias','fundamentos','sujetoAprendizaje','procesos','neurobiologia','desarrollo','clinica1','articulacion3','etica','epistemologia','psicologysalud','articulacion2']},

      /* Semestre 6 */
      {id:'probContemp', name:'Problemáticas contemporáneas de la psicología Social', credits:5, module:'Psicología', sem:6, prereqs:['psicosocial','articulacion1','teorias','fundamentos','articulacion5','articulacion4','articulacion2']},
      {id:'psicologiaEduc', name:'Psicología y Educación', credits:5, module:'Psicología', sem:6, prereqs:['sujetoAprendizaje','procesos','neurobiologia','desarrollo','fundamentos']},
      {id:'dispositivos', name:'Dispositivos Psicoterapéuticos', credits:5, module:'Metodológico', sem:6, prereqs:['clinica2','herrClin','entrevista','inicioForm','clinica1','articulacion3','teorias','fundamentos','etica','epistemologia']},
      {id:'proyectos6', name:'Proyectos (5/10 cred)', credits:10, module:'Prácticas', sem:6, prereqs:['cicloInicialComplete','diseno','metodosCuant','metodosCual']},
      {id:'practicaIntegral6', name:'Práctica de Ciclo Formación Integral', credits:10, module:'Prácticas', sem:6, prereqs:['cicloInicialComplete','etica','psicologysalud','sujetoAprendizaje','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'articulacion6', name:'Articulación de Saberes VI: Diálogos y ámbitos interdisciplinarios', credits:5, module:'Articulación', sem:6, prereqs:['articulacion1','articulacion2','articulacion3','teorias','fundamentos']},
      {id:'construccionIt6', name:'Construcción de itinerario', credits:5, module:'Referencial', sem:6, prereqs:['psicosocial','articulacion1','teorias','fundamentos','sujetoAprendizaje','procesos','neurobiologia','desarrollo','clinica1','articulacion3','etica','epistemologia','psicologysalud','articulacion2']},

      /* Semestre 7 */
      {id:'optativa7p', name:'Optativas (Psicología) 5 cred', credits:5, module:'Psicología', sem:7, prereqs:['cicloInicialComplete','etica','sujetoAprendizaje','psicologysalud','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'optativa7m', name:'Optativas (Metodológico) 5 cred', credits:5, module:'Metodológico', sem:7, prereqs:['cicloInicialComplete','etica','sujetoAprendizaje','psicologysalud','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'idioma', name:'Idioma: Inglés o Portugués', credits:5, module:'Metodológico', sem:7, prereqs:['cicloInicialComplete']},
      {id:'proyectos7', name:'Proyectos (10 cred)', credits:10, module:'Prácticas', sem:7, prereqs:['cicloInicialComplete','diseno','metodosCuant','metodosCual']},
      {id:'practicaGrad7', name:'Práctica de Graduación (20 cred)', credits:20, module:'Prácticas', sem:7, prereqs:['practicaIntegral','cicloInicialComplete','etica','psicologysalud','sujetoAprendizaje','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'optativaArt7', name:'Optativas (Articulación) 5 cred', credits:5, module:'Articulación', sem:7, prereqs:['cicloInicialComplete','etica','sujetoAprendizaje','psicologysalud','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'referencialEgreso7', name:'Referencial de egreso (5 cred)', credits:5, module:'Referencial', sem:7, prereqs:['cicloInicialComplete','cicloIntegralComplete','practicaCredits20']},

      /* Semestre 8 */
      {id:'optativa8p', name:'Optativas (Psicología) 5 cred', credits:5, module:'Psicología', sem:8, prereqs:['cicloInicialComplete','etica','sujetoAprendizaje','psicologysalud','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'trabajofinal', name:'Trabajo final (40 cred)', credits:40, module:'Psicología', sem:8, prereqs:['cicloInicialComplete','cicloIntegralComplete','practicaCredits20','tutoriaPrereqs']},
      {id:'optativa8m', name:'Optativas (Metodológico) 5 cred', credits:5, module:'Metodológico', sem:8, prereqs:['cicloInicialComplete','etica','sujetoAprendizaje','psicologysalud','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'proyectos8', name:'Proyectos (10 cred)', credits:10, module:'Prácticas', sem:8, prereqs:['cicloInicialComplete','diseno','metodosCuant','metodosCual']},
      {id:'practicaGrad8', name:'Práctica de Graduación (20 cred)', credits:20, module:'Prácticas', sem:8, prereqs:['practicaIntegral','cicloInicialComplete','etica','psicologysalud','sujetoAprendizaje','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'optativaArt8', name:'Optativas (Articulación) 5 cred', credits:5, module:'Articulación', sem:8, prereqs:['cicloInicialComplete','etica','sujetoAprendizaje','psicologysalud','clinica1','articulacion3','herrClin','herrSocial','psicosocial']},
      {id:'referencialEgreso8', name:'Referencial de egreso (5 cred)', credits:5, module:'Referencial', sem:8, prereqs:['cicloInicialComplete','cicloIntegralComplete','practicaCredits20']},

      /* Sin módulo */
      {id:'cooperacion', name:'Cooperación Institucional (u optativa de cualquier Módulo)', credits:5, module:'Sin', sem:7, prereqs:[]}
    ];

    // Module credit totals (from your numbers)
    const moduleTotals = {
      'Psicología':145,
      'Metodológico':60,
      'Prácticas':50,
      'Articulación':40,
      'Referencial':20,
      'Sin':5
    };

    // helper: normalize prereq strings (strip parenthesis words and lowercase)
    function norm(x){return x?x.toString().toLowerCase().replace(/\s*\(.*?\)\s*/g,'').trim():''}

    // map id->course
    const courseById = {};
    courses.forEach(c=>courseById[c.id]=c);

    // load state from localStorage
    const STORAGE_KEY = 'mallaPsicoState-v1';
    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
    if(!state.approved) state.approved = {};

    function save(){localStorage.setItem(STORAGE_KEY, JSON.stringify(state))}

    // compute sums per module
    function computeModuleSums(){
      const sums = {Psicología:0,Metodológico:0,Prácticas:0,Articulación:0,Referencial:0,Sin:0};
      let total=0;
      courses.forEach(c=>{
        if(state.approved[c.id]){
          const key = c.module;
          sums[key] = (sums[key]||0) + c.credits;
          total += c.credits;
        }
      });
      return {sums,total};
    }

    // Determine if a course is unlocked: all prereqs satisfied OR semester threshold
    function isPrereqSatisfied(prereqName){
      if(!prereqName) return true;
      const n = norm(prereqName);
      // special tokens
      if(n==='cicloinicialcomplete' || n==='ciclo inicial completo'){
        // define as sum of sem1+2 credits
        const sem12 = courses.filter(c=>c.sem===1||c.sem===2);
        const sum12 = sem12.reduce((s,c)=>s + (state.approved[c.id]?c.credits:0),0);
        const total12 = sem12.reduce((s,c)=>s+c.credits,0);
        return sum12>=total12;
      }
      if(n==='ciclointegralcomplete' || n==='ciclo integral completo'){
        // sem 3-6 complete
        const sem = courses.filter(c=>c.sem>=3 && c.sem<=6);
        const sum = sem.reduce((s,c)=>s + (state.approved[c.id]?c.credits:0),0);
        const total = sem.reduce((s,c)=>s+c.credits,0);
        return sum>=total;
      }
      if(n==='practicacredits20' || n==='practicacredits20'){
        // 20 credits in practices/projects
        const prac = courses.filter(c=>c.module==='Prácticas');
        const sum = prac.reduce((s,c)=>s + (state.approved[c.id]?c.credits:0),0);
        return sum>=20;
      }
      if(n==='tutoriaprequisites' || n==='tutoriaPrereqs'.toLowerCase()){
        // treat as ciclo initial + ciclo integral + practicaCredits20
        return isPrereqSatisfied('ciclo inicial completo') && isPrereqSatisfied('ciclo integral completo') && isPrereqSatisfied('practicaCredits20');
      }

      // otherwise find a course whose normalized name matches
      for(const c of courses){
        if(norm(c.name)===n){
          return !!state.approved[c.id];
        }
      }
      // also allow matching by id
      if(courseById[prereqName]) return !!state.approved[prereqName];

      // if not found, fallback: treat as satisfied to avoid permanent block for ambiguous texts
      return true;
    }

    function courseUnlocked(c){
      // If course has explicit prereqs, check them
      if(c.prereqs && c.prereqs.length>0){
        return c.prereqs.every(p=>isPrereqSatisfied(p));
      }
      // else use semester thresholds
      const totalApproved = computeModuleSums().total;
      if(c.sem<=2) return true;
      if(c.sem===3) return totalApproved>=45; // per your rule
      if(c.sem===4) return totalApproved>=75;
      if(c.sem===5) return totalApproved>=120;
      if(c.sem===6) return totalApproved>=160;
      if(c.sem===7) return totalApproved>=220;
      if(c.sem===8) return totalApproved>=260;
      return true;
    }

    // Build grid headers and rows
    const grid = document.getElementById('grid');

    function build(){
      grid.innerHTML='';
      // first row: blank (module header cell) + cycle headers (spanning 2 cols) + totals header
      const blank = document.createElement('div'); blank.className='col-head'; blank.textContent='Módulos / Semestres'; grid.appendChild(blank);
      // cycles: Ciclo Inicial (1+2), Ciclo de Formación Integral (3-6 spans 4 columns), Ciclo de Graduación (7+8)
      const cycle1 = document.createElement('div'); cycle1.className='cycle-header'; cycle1.textContent='Ciclo Inicial'; cycle1.style.gridColumn='span 2'; grid.appendChild(cycle1);
      const cycle2 = document.createElement('div'); cycle2.className='cycle-header'; cycle2.textContent='Ciclo de Formación Integral'; cycle2.style.gridColumn='span 4'; grid.appendChild(cycle2);
      const cycle3 = document.createElement('div'); cycle3.className='cycle-header'; cycle3.textContent='Ciclo de Graduación'; cycle3.style.gridColumn='span 2'; grid.appendChild(cycle3);
      const totalsHead = document.createElement('div'); totalsHead.className='col-head'; totalsHead.textContent='Créditos (por módulo)'; grid.appendChild(totalsHead);

      // second row: semester headers: first column blank
      const modHead = document.createElement('div'); modHead.className='module-name'; modHead.textContent=''; grid.appendChild(modHead);
      for(let s=1;s<=8;s++){
        const sh = document.createElement('div'); sh.className='col-head'; sh.textContent=(s===1?'1er semestre':s===2?'2do semestre':s+'º semestre'); grid.appendChild(sh);
      }
      const totHead2 = document.createElement('div'); totHead2.className='col-head'; totHead2.textContent='Logros actuales / Totales'; grid.appendChild(totHead2);

      // rows by module in specific order
      const modulesOrder = ['Psicología','Metodológico','Prácticas','Articulación','Referencial','Sin'];
      modulesOrder.forEach(mod=>{
        // module name cell
        const mn = document.createElement('div'); mn.className='module-name'; mn.textContent = mod==='Sin'?'':(mod==='Prácticas'?'Módulo Prácticas y Proyectos':(mod==='Articulación'?'Módulo Articulación de Saberes':(mod==='Referencial'?'Módulo Referencial':(mod==='Metodológico'?'Módulo Metodológico':'Módulo de Psicología'))));
        grid.appendChild(mn);
        // semester cells
        for(let s=1;s<=8;s++){
          const cell = document.createElement('div'); cell.className='semester-cell'; cell.dataset.sem=s; cell.dataset.module=mod;
          // find courses matching module and semester
          const list = courses.filter(c=>c.module===mod && c.sem===s);
          list.forEach(c=>{
            const unlocked = courseUnlocked(c);
            const approved = !!state.approved[c.id];
            const el = document.createElement('div'); el.className='course'; el.dataset.id=c.id;
            if(!unlocked) el.classList.add('locked');
            if(approved) el.classList.add('approved');
            const name = document.createElement('div'); name.className='name'; name.textContent=c.name;
            const cred = document.createElement('div'); cred.className='cred'; cred.textContent=c.credits+'cr';
            el.appendChild(name); el.appendChild(cred);
            el.addEventListener('click', (e)=>{
              e.stopPropagation();
              onCourseClick(c.id);
            });
            el.title = (c.prereqs && c.prereqs.length?('Previaturas: ' + c.prereqs.join(', ')):'');
            cell.appendChild(el);
          });
          grid.appendChild(cell);
        }
        // totals column cell for this module
        const totCell = document.createElement('div'); totCell.className='totals-col';
        const box = document.createElement('div'); box.className='total-box';
        box.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${mod==='Sin'? 'Sin módulo' : (mod==='Prácticas'?'Prácticas y Proyectos':mod)}</div>`;
        totCell.appendChild(box);
        grid.appendChild(totCell);
      });

      // after building grid, we need to fill the totals cells with dynamic values
      updateTotals();
    }

    function updateTotals(){
      // find all total-box elements in order
      const boxes = Array.from(document.querySelectorAll('.total-box'));
      const {sums,total} = computeModuleSums();
      const order = ['Psicología','Metodológico','Prácticas','Articulación','Referencial','Sin'];
      boxes.forEach((box,i)=>{
        const mod = order[i];
        box.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${mod==='Sin'? 'Sin módulo' : (mod==='Prácticas'?'Prácticas y Proyectos':mod)}</div>`;
        const row = document.createElement('div'); row.className='total-row';
        row.innerHTML = `<div>${sums[mod]||0} / ${moduleTotals[mod]}</div><div style="font-weight:700">${Math.round(((sums[mod]||0)/moduleTotals[mod])*100)}%</div>`;
        box.appendChild(row);
      });
      // also show overall total at the very bottom of last box
      const lastBox = boxes[boxes.length-1];
      const overall = document.createElement('div'); overall.style.marginTop='8px'; overall.style.fontSize='12px'; overall.innerHTML = `<div style="font-weight:700">Total aprobado: ${total} / 320</div>`;
      lastBox.appendChild(overall);

      // After totals updated, update each course's locked/unlocked state in DOM
      document.querySelectorAll('.course').forEach(el=>{
        const id = el.dataset.id; const c = courseById[id];
        const unlocked = courseUnlocked(c);
        el.classList.toggle('locked',!unlocked);
      });
    }

    function onCourseClick(id){
      const c = courseById[id];
      const unlocked = courseUnlocked(c);
      if(!unlocked) {
        // show quick details and reason
        showDetails(c,true);
        return;
      }
      // toggle approval
      state.approved[id] = !state.approved[id];
      // if toggled off, ensure that any course depending on this becomes unapproved automatically
      if(!state.approved[id]){
        // cascade: any course whose prereqs include this course should be turned off
        let changed = true;
        while(changed){
          changed = false;
          for(const oc of courses){
            if(state.approved[oc.id]){
              const ok = (oc.prereqs && oc.prereqs.length>0)? oc.prereqs.every(p=>isPrereqSatisfied(p)) : true;
              if(!ok){ state.approved[oc.id]=false; changed=true; }
            }
          }
        }
      }
      save();
      build();
    }

    // details panel
    const details = document.getElementById('details');
    const dname = document.getElementById('dname');
    const ddesc = document.getElementById('ddesc');
    const dpr = document.getElementById('dpr');
    const dToggle = document.getElementById('dToggle');
    const dClose = document.getElementById('dClose');
    let currentDetail = null;

    function showDetails(course,onlyShow=false){
      currentDetail = course;
      dname.textContent = course.name + ' ('+course.credits+'cr)';
      ddesc.textContent = 'Módulo: ' + (course.module==='Sin'?'(sin módulo)':course.module);
      dpr.textContent = 'Previaturas: ' + (course.prereqs && course.prereqs.length? course.prereqs.join(', '): 'Ninguna explicita.');
      details.style.display = 'block';
      dToggle.textContent = state.approved[course.id]? 'Desaprobar': 'Aprobar';
      dToggle.disabled = !courseUnlocked(course);
      dToggle.style.opacity = courseUnlocked(course)? '1':'0.5';
      if(onlyShow) return;
    }
    dClose.addEventListener('click', ()=>{ details.style.display='none'; });
    dToggle.addEventListener('click', ()=>{
      if(!currentDetail) return;
      if(!courseUnlocked(currentDetail)) return;
      onCourseClick(currentDetail.id);
      details.style.display='none';
    });

    // click outside to close details
    document.body.addEventListener('click', (e)=>{
      if(!details.contains(e.target)) details.style.display='none';
    });

    // initial build
    build();
  </script>
</body>
</html>
